# ============================================================================
# SECURITY HEADERS & CONFIGURATION
# ============================================================================
# This file implements security best practices and headers to protect against:
# - XSS (Cross-Site Scripting)
# - Clickjacking
# - MIME type sniffing
# - Mixed content attacks
# - Directory listing
# - Unauthorized access

<IfModule mod_headers.c>
  # ========================================================================
  # 1. CONTENT SECURITY POLICY (CSP)
  # ========================================================================
  # Prevents XSS attacks by restricting resource loading
  Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com data:; img-src 'self' data: https: blob:; connect-src 'self' https://formsubmit.co; frame-ancestors 'none'; base-uri 'self'; form-action 'self' https://formsubmit.co; upgrade-insecure-requests"

  # ========================================================================
  # 2. CLICKJACKING PROTECTION
  # ========================================================================
  # Prevents site from being embedded in iframes
  Header set X-Frame-Options "SAMEORIGIN"

  # ========================================================================
  # 3. MIME TYPE PROTECTION
  # ========================================================================
  # Prevents browser from MIME sniffing
  Header set X-Content-Type-Options "nosniff"

  # ========================================================================
  # 4. XSS PROTECTION
  # ========================================================================
  # Enable browser's built-in XSS protection
  Header set X-XSS-Protection "1; mode=block"

  # ========================================================================
  # 5. REFERRER POLICY
  # ========================================================================
  # Controls how much referrer info is shared
  Header set Referrer-Policy "strict-origin-when-cross-origin"

  # ========================================================================
  # 6. FEATURE POLICY (Permissions Policy)
  # ========================================================================
  # Disable potentially dangerous browser features
  Header set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"

  # ========================================================================
  # 7. STRICT TRANSPORT SECURITY (HSTS)
  # ========================================================================
  # Force HTTPS connections for 1 year
  Header set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

  # ========================================================================
  # 8. NO CACHE FOR HTML (Cache Buster)
  # ========================================================================
  # Ensure users always get the latest HTML version
  <FilesMatch "\.html?$">
    Header set Cache-Control "public, max-age=3600, must-revalidate"
    Header set Pragma "public"
  </FilesMatch>

  # ========================================================================
  # 9. CACHE STATIC ASSETS
  # ========================================================================
  # Allow browsers to cache CSS, JS, images for 1 year
  <FilesMatch "\.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
    Header set Expires "Wed, 21 Oct 2026 07:28:00 GMT"
  </FilesMatch>
</IfModule>

# ============================================================================
# 2. HTTPS ENFORCEMENT
# ============================================================================
# Redirect all HTTP traffic to HTTPS
<IfModule mod_rewrite.c>
  RewriteEngine On

  # Redirect HTTP to HTTPS
  RewriteCond %{HTTPS} off
  RewriteCond %{HTTP_HOST} !^localhost [NC]
  RewriteCond %{HTTP_HOST} !^127\.0\.0\.1 [NC]
  RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

  # Remove trailing slashes from URLs (except directories)
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule ^(.+)/$ /$1 [L,R=301]
</IfModule>

# ============================================================================
# 3. DISABLE DIRECTORY LISTING
# ============================================================================
# Prevent users from seeing directory contents
Options -Indexes
Options +FollowSymlinks

# ============================================================================
# 4. DISABLE SPECIFIC FILE ACCESS
# ============================================================================
# Protect sensitive files from direct access
<FilesMatch "\.env|\.git|\.gitignore|composer\.lock|package\.lock|\.htaccess|\.htpasswd">
  <IfModule mod_authz_core.c>
    Require all denied
  </IfModule>
  <IfModule !mod_authz_core.c>
    Order allow,deny
    Deny from all
  </IfModule>
</FilesMatch>

# ============================================================================
# 5. ENABLE GZIP COMPRESSION
# ============================================================================
# Reduce file sizes for faster transfers
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/plain
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/xml
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE text/javascript
  AddOutputFilterByType DEFLATE application/xml
  AddOutputFilterByType DEFLATE application/xhtml+xml
  AddOutputFilterByType DEFLATE application/rss+xml
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/x-javascript
  AddOutputFilterByType DEFLATE application/json
</IfModule>

# ============================================================================
# 6. SECURITY HEADERS FOR FORMS
# ============================================================================
# Additional protection for form submission
<IfModule mod_headers.c>
  Header set X-Permitted-Cross-Domain-Policies "none"
  Header set X-UA-Compatible "IE=edge"
</IfModule>

# ============================================================================
# 7. BLOCK COMMON ATTACKS
# ============================================================================
<IfModule mod_rewrite.c>
  RewriteEngine On

  # Block SQL injection attempts
  RewriteCond %{QUERY_STRING} (\=|\+)union(\+|%20)
  RewriteRule ^ - [F]

  RewriteCond %{QUERY_STRING} (\=|\+)select(\+|%20)
  RewriteRule ^ - [F]

  RewriteCond %{QUERY_STRING} (\=|\+)insert(\+|%20)
  RewriteRule ^ - [F]

  # Block script injection attempts
  RewriteCond %{QUERY_STRING} <script
  RewriteRule ^ - [F]

  # Block null bytes
  RewriteCond %{QUERY_STRING} %00
  RewriteRule ^ - [F]
</IfModule>
